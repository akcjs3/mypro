<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Monitor Sketcher Â· ë§ˆì´í˜ì´ì§€</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="/static/css/style.css"" />

  <style>
    /* ==============================
       mypage ì „ìš© ìŠ¤íƒ€ì¼
    =============================== */
    .sessions-head {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
}

.sessions-title {
  font-size: 2rem;
  font-weight: 800;
  color: #fff;
}
.date-filter {
  display: flex;
  align-items: center;
  gap: 10px;
  opacity: 0.85;
  font-size: 0.92rem;
}

.date-filter input {
  background: transparent;
  border: none;
  border-bottom: 1px solid rgba(200,200,255,0.5);
  color: #fff;
  padding: 4px 2px;
  outline: none;
}

.date-filter input::-webkit-calendar-picker-indicator {
  filter: invert(1);
  cursor: pointer;
}
.session-item {
  background: rgba(10,10,30,0.85);
  border: 1px solid rgba(120,120,200,0.35);
  border-radius: 14px;
  padding: 1.1rem 1.4rem;
  margin-bottom: 1rem;   /* ë°•ìŠ¤ ê°„ ê°„ê²© ì¶”ê°€ */
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.session-info {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.session-title {
  font-size: 1.15rem;
  font-weight: 800;
  color: #fff;
}

.session-sub {
  font-size: .9rem;
  opacity: 0.85;
}

.session-focus {
  font-size: 1.1rem;
  font-weight: 700;
  color: #ff8fb3;
}


    .mypage-card,
    .mypage-card:hover {
      transform: none !important;
      filter: none !important;
      background: inherit !important;
      box-shadow: none !important;
      cursor: default !important;
    }

    .mypage-hero-title {
      font-size: clamp(1.7rem, 3vw, 2.2rem);
      font-weight: 800;
      margin-bottom: 0.5rem;
    }
    .mypage-hero-subtitle {
      font-size: 0.95rem;
      color: rgba(235,235,255,0.85);
      margin-top: 0.8rem;
      margin-bottom: 1.6rem;
    }

    .mypage-actions {
      display: flex;
      gap: .8rem;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 1rem;
    }

    .mypage-action-btn {
      min-width: 180px;
      padding: 0.8rem 1.2rem;
      border-radius: 999px;
      background: rgba(10,10,35,0.9);
      border: 1px solid rgba(120,120,200,0.6);
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      transition: .15s;
    }
    .mypage-action-btn.primary {
      background: linear-gradient(90deg, #7c4dff, #ff6b6b);
      border: none;
    }

    .hero-card.mypage-expanded {
      min-height: 560px;
    }
    .hero-card.mypage-expanded .mypage-initial {
      opacity: 0;
      pointer-events: none;
      transform: translateY(-8px);
      transition: .35s;
    }

    .mypage-panel {
      display: none;
      position: absolute;
      inset: 0;
      padding: 3rem 2.3rem;
      overflow-y: auto;
      color: #f6f6ff;
    }

    .hero-card.sessions-mode .mypage-sessions-panel { display: block; }
    .hero-card.study-mode .mypage-study-panel { display: block; }

    .mypage-back {
      display: none;
      position: fixed;
      right: 160px;
      top: 50%;
      transform: translateY(-50%);
      width: 86px;
      height: 86px;
      border-radius: 50%;
      background: rgba(10,10,35,0.94);
      border: 1px solid rgba(120,120,200,0.55);
      color:#fff;
      font-weight: 900;
      cursor: pointer;
      z-index: 999;
    }
    .mypage-back.show { display: flex; align-items: center; justify-content: center; }

    .session-item {
      background: rgba(5,5,25,0.95);
      border:1px solid rgba(120,120,200,0.5);
      border-radius:14px;
      padding:0.7rem 1rem;
      cursor:pointer;
      min-height: 62px;
      transition:.15s;
    }
    .session-item:hover {
      background: rgba(20,20,55,0.95);
      transform: translateY(-1px);
    }

    .session-meta {
      display:flex;
      align-items:center;
      gap:0.7rem;
      overflow:hidden;
    }

    /* ëª¨ë‹¬ */
    .modal-overlay {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.6);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
    }
    .modal-overlay.show { display:flex; }
    .detail-wrap {
  display: flex;
  gap: 2rem;
  padding: 1.5rem;
}

.detail-left {
  flex: 1.1;
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.detail-right {
  flex: 1;
  background: rgba(10,10,30,0.7);
  padding: 1rem;
  border-radius: 12px;
}

.detail-title {
  font-size: 1.4rem;
  font-weight: 700;
}

.summary-stack {
  display: flex;
  flex-direction: column;
  gap: 18px;
}

.summary-box {
  background: rgba(20,20,55,0.7);
  padding: 0.95rem 1.15rem;  /* âœ… ì¡°ê¸ˆ ë” ì—¬ìœ  */
  border-radius: 10px;
  line-height: 1.65;         /* âœ… ê¸€ì ê°„ê²© */
  display: flex;             /* âœ… ë¼ë²¨-ê°’ ê°„ê²© ê· ì¼ */
  justify-content: space-between;
  align-items: center;
}
.summary-box b {
  font-weight: 800;
  letter-spacing: .2px;      /* ì‚´ì§ ë˜ë ·í•˜ê²Œ */
}

.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);   /* ì•½ê°„ ì–´ë‘¡ê²Œ */
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.modal-overlay.show {
  display: flex;
}

/* ëª¨ë‹¬ ë°•ìŠ¤ */
.modal-card {
  background: linear-gradient(145deg, rgba(20,20,40,0.95), rgba(10,10,25,0.95));
  border: 1px solid rgba(120,120,200,0.3);
  border-radius: 18px;
  padding: 1.8rem;
  width: 680px;
  max-width: 92%;
  color: #fff;
  position: relative;
  box-shadow: 0 10px 40px rgba(0,0,0,0.45);
  animation: modalPop 0.25s ease-out;
}

@keyframes modalPop {
  from { transform: scale(0.92); opacity: 0; }
  to   { transform: scale(1); opacity: 1; }
}
.modal-close {
  position: absolute;
  top: 12px;
  right: 12px;
  background: rgba(50,50,90,0.6);
  color: #fff;
  border: none;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  font-size: 1.2rem;
  cursor: pointer;
  transition: 0.15s;
}

.modal-close:hover {
  background: rgba(80,80,150,0.8);
  transform: scale(1.07);
}
.mypage-panel {
  overflow: hidden;   /* âœ… auto â†’ hidden */
}
.hero-card.mypage-expanded {
  min-height: unset; 
  height: calc(100vh - 220px);  /* âœ… í—¤ë”/í‘¸í„° ì œì™¸í•˜ê³  í™”ë©´ì— ë”± */
}
/* ì „ì²´ í˜ì´ì§€ëŠ” ê³ ì •(ë°”ë”” ìŠ¤í¬ë¡¤ ë°©ì§€) */
html, body {
  height: 100%;
  overflow: hidden;
}

/* í™•ì¥ëœ hero ì¹´ë“œê°€ í™”ë©´ ì•ˆì— ë“¤ì–´ì˜¤ê²Œ ìœ ì§€ */
.hero-card.mypage-expanded {
  min-height: unset;
  height: calc(100vh - 220px);
  position: relative; /* íŒ¨ë„ absolute ê¸°ì¤€ */
}

/* âœ… ì„¸ì…˜/ìŠ¤í„°ë”” íŒ¨ë„ ë‚´ë¶€ë§Œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥ */
.mypage-sessions-panel,
.mypage-study-panel {
  overflow-y: auto;
  height: 100%;            /* hero-card ì•ˆ ë†’ì´ ê½‰ ì±„ì›€ */
  padding-bottom: 2rem;    /* ë§¨ ì•„ë˜ ì˜ë¦¼ ë°©ì§€ */
  overscroll-behavior: contain; /* ìŠ¤í¬ë¡¤ íŠ ë°©ì§€ */
}

/* ==============================
   Study íŒ¨ë„ ë ˆì´ì•„ì›ƒ/í¬ê¸° ì¡°ì •
============================== */

.study-head {
  display: flex;
  justify-content: flex-start;
  margin-bottom: 1rem;
}

/* íƒ€ì´í‹€ì„ â€œì„¸ì…˜ ê²°ê³¼ì°½ ê²€ì‚¬ ìš”ì•½â€ í¬ê¸°ë¡œ */
.study-title {
  font-size: 1.4rem;   /* ê²€ì‚¬ ìš”ì•½ê¸‰ */
  font-weight: 800;
  color: #fff;
}

/* ì¹´ë“œ 3ê°œ ìˆ˜í‰ ì •ë ¬ */
.study-cards-row {
  display: flex;
  gap: 1rem;
  align-items: stretch;
  margin-bottom: 1.2rem;
  flex-wrap: wrap; /* ëª¨ë°”ì¼ ëŒ€ì‘ */
}

/* ì¹´ë“œ ë””ìì¸ = ê¸°ì¡´ summary-box ëŠë‚Œ */
.study-card {
  flex: 1;
  min-width: 180px;
  background: rgba(20,20,55,0.7);
  border: 1px solid rgba(120,120,200,0.35);
  padding: .8rem 1rem;
  border-radius: 12px;
}

/* ì¹´ë“œ ì•ˆ í…ìŠ¤íŠ¸ */
.study-card .k {
  font-size: .9rem;
  opacity: .85;
  margin-bottom: .4rem;
}
.study-card .v {
  font-size: 1.2rem;
  font-weight: 800;
  color: #ff8fb3;
}

/* ê·¸ë˜í”„ ì˜ì—­ ì¡°ê¸ˆ ì¤„ì—¬ì„œ ìŠ¤í¬ë¡¤ ë°©ì§€ */
.study-chart-wrap {
  background: rgba(10,10,30,0.55);
  border: 1px solid rgba(120,120,200,0.25);
  border-radius: 12px;
  padding: 0.9rem 1rem;
}

/* ì œëª© ê¸€ìë§Œ êµµê²Œ */
.study-chart-title {
  font-weight: 800;
  margin-bottom: .6rem;
  font-size: 1rem;
}

  </style>
</head>

<body>
  <div class="app">

    <!-- ìƒë‹¨ í—¤ë” -->
    <header class="site-header">
      <div class="header-inner">
        <a href="index.html" class="brand brand-link">
          <div class="brand-logo-mark">
            <img src="./src/logo.png" alt="Monitor Sketcher ë¡œê³ " />
          </div>
          <span class="brand-text">Monitor Sketcher</span>
        </a>

        <nav class="main-nav">
          <a href="test.html" class="nav-link">ê²€ì‚¬</a>
          <a href="ranking.html" class="nav-link">ë­í‚¹</a>
          <a href="about.html" class="nav-link">ì†Œê°œ</a>
          <a href="contact.html" class="nav-link">ë¬¸ì˜</a>
        </nav>

        <div class="header-actions">
          <span id="user-nickname-label" class="nickname-label hidden"></span>
          <button id="mypage-btn" class="header-btn outline-btn hidden">ë§ˆì´í˜ì´ì§€</button>
          <button id="login-btn" class="header-btn primary-btn">ë¡œê·¸ì¸</button>
          <button id="logout-btn" class="header-btn outline-btn hidden">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>
    </header>


    <!-- ë©”ì¸ íˆì–´ë¡œ -->
    <main class="hero">
      <section class="hero-card mypage-card">
        <div class="hero-glow"></div>

        <!-- ì´ˆê¸° í™”ë©´ -->
        <div class="hero-content mypage-initial">
          <img src="./src/logo.png" alt="logo" class="hero-logo" />
          <h1 class="mypage-hero-title">ë§ˆì´í˜ì´ì§€</h1>
          <p class="mypage-hero-subtitle">ë‚˜ì˜ ê²€ì‚¬ ê¸°ë¡ê³¼ ì§‘ì¤‘ë„ ë³€í™”ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.</p>

          <div class="mypage-actions">
            <button id="btn-sessions" class="mypage-action-btn">ê¸°ë¡ ì¡°íšŒ</button>
            <button id="btn-study" class="mypage-action-btn primary">ëˆ„ì  ì§‘ì¤‘ë„</button>
          </div>
        </div>

        <!-- ê¸°ë¡ ì¡°íšŒ íŒ¨ë„ -->
        <div class="mypage-panel mypage-sessions-panel">
          <div class="sessions-head">
            <div class="sessions-title">ê¸°ë¡ ì‚´í´ë³´ê¸°</div>

            <div class="date-filter">
              <span style="font-size:.82rem;opacity:.9;">ê¸°ê°„ ì„¤ì •</span>
              <input id="from-date" type="date" />
              <span style="opacity:.7;">~</span>
              <input id="to-date" type="date" />
            </div>
          </div>

          <div id="session-list" class="session-list"></div>
          <button id="btn-back-from-sessions" class="mypage-back">ëŒì•„ê°€ê¸°</button>
        </div>

        <!-- Study íŒ¨ë„ -->
        <div class="mypage-panel mypage-study-panel">

  <!-- ì™¼ìª½ ìœ„ íƒ€ì´í‹€ -->
  <div class="study-head">
    <div class="study-title">Study ì§‘ì¤‘ë„ ë¶„ì„</div>
  </div>

  <!-- ì§€í‘œ ì¹´ë“œ 3ê°œ ìˆ˜í‰ ë°°ì¹˜ -->
  <div class="study-cards-row">
    <div class="study-card">
      <div class="k">Study ì„ íƒ íšŸìˆ˜</div>
      <div id="study-total-sessions" class="v">-</div>
    </div>

    <div class="study-card">
      <div class="k">ëˆ„ì  í‰ê·  ì§‘ì¤‘ë„</div>
      <div id="study-avg-focus" class="v">-</div>
    </div>

    <div class="study-card">
      <div class="k">ê°€ì¥ ë°©í•´ëœ í™œë™</div>
      <div id="study-top-distract" class="v">-</div>
    </div>
  </div>

  <!-- ê·¸ë˜í”„ -->
  <div class="study-chart-wrap">
    <div class="study-chart-title">ì¼ë³„ ì§‘ì¤‘ë„ ë³€í™”</div>
    <!-- height ì‚´ì§ ì¤„ì—¬ì„œ ìŠ¤í¬ë¡¤ ì—†ê²Œ -->
    <canvas id="weekly-focus-chart" height="120"></canvas>
  </div>

  <button id="btn-back-from-study" class="mypage-back">ëŒì•„ê°€ê¸°</button>
</div>

      </section>
    </main>

    <footer class="footer">
      <span>ì¡¸ì—… ì‘í’ˆ Â· Monitor Sketcher Â· PC ì‚¬ìš© ê¸°ë¡ ê¸°ë°˜ ì§‘ì¤‘ë„ ë¶„ì„ ì„œë¹„ìŠ¤</span>
    </footer>

  </div>

  <!-- ëª¨ë‹¬ 1ê°œë§Œ ìœ ì§€ -->
  <div id="sessionModal" class="modal-overlay">
  <div class="modal-card">
    <button id="modalClose" class="modal-close">Ã—</button>
    <div id="modalBody"></div>
    </div>
</div>



  <!-- ìŠ¤í¬ë¦½íŠ¸ë“¤ -->
  <script src="/static/js/main.js""></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- ë‚´ë¶€ JS (ì›ë³¸ 100% ìœ ì§€) -->
  <script>
    /* --------------------------------------
       ğŸ”’ 1) getCurrentUser() ë¡œë”© ëŒ€ê¸°
    -------------------------------------- */
    async function waitForGetCurrentUser() {
      return new Promise(resolve => {
        const timer = setInterval(() => {
          if (typeof getCurrentUser === "function") {
            clearInterval(timer);
            resolve();
          }
        }, 30);
      });
    }

    /* --------------------------------------
       ğŸ”¥ 2) DOMContentLoaded
    -------------------------------------- */
    document.addEventListener("DOMContentLoaded", async () => {

      await waitForGetCurrentUser();
      const user = getCurrentUser();

      if (!user || !user.user_id) {
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        window.location.href = "login.html";
        return;
      }

      const heroCard = document.querySelector(".mypage-card");

      const btnSessions = document.getElementById("btn-sessions");
      const btnStudy = document.getElementById("btn-study");
      const backSessions = document.getElementById("btn-back-from-sessions");
      const backStudy = document.getElementById("btn-back-from-study");

      function openSessionsMode() {
        heroCard.classList.add("mypage-expanded", "sessions-mode");
        heroCard.classList.remove("study-mode");
        backSessions.classList.add("show");
        backStudy.classList.remove("show");
        loadSessions();
      }
      function openStudyMode() {
        heroCard.classList.add("mypage-expanded", "study-mode");
        heroCard.classList.remove("sessions-mode");
        backStudy.classList.add("show");
        backSessions.classList.remove("show");
        loadStudySummary();
      }
      function backToInitial() {
        heroCard.classList.remove("mypage-expanded", "sessions-mode", "study-mode");
        backSessions.classList.remove("show");
        backStudy.classList.remove("show");
      }

      btnSessions.addEventListener("click", openSessionsMode);
      btnStudy.addEventListener("click", openStudyMode);
      backSessions.addEventListener("click", backToInitial);
      backStudy.addEventListener("click", backToInitial);

      /* ëª¨ë‹¬ */
      const modal = document.getElementById("sessionModal");
      const modalBody = document.getElementById("modalBody");
      const modalClose = document.getElementById("modalClose");

      function openModal() { modal.classList.add("show"); }
      function closeModal() {
        modal.classList.remove("show");
        destroyDetailCharts();
      }
      modalClose.addEventListener("click", closeModal);
      modal.addEventListener("click", e => { if (e.target === modal) closeModal(); });

      /* --------------------------------------
         ì„¸ì…˜ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
      -------------------------------------- */
      const sessionListEl = document.getElementById("session-list");
      const fromDateEl = document.getElementById("from-date");
      const toDateEl = document.getElementById("to-date");

      fromDateEl.addEventListener("change", loadSessions);
      toDateEl.addEventListener("change", loadSessions);

      async function loadSessions() {
        const from = fromDateEl.value;
        const to = toDateEl.value;

        const url = new URL("/api/mypage/sessions", window.location.origin);
        url.searchParams.set("userId", user.user_id);
        if (from) url.searchParams.set("dateFrom", from);
        if (to) url.searchParams.set("dateTo", to);

        sessionListEl.innerHTML = `<div style="opacity:.85;">ì„¸ì…˜ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>`;

        try {
          const res = await fetch(url.toString());
          const data = await res.json();

          if (!res.ok || !data.ok) {
            sessionListEl.innerHTML = `<div style="opacity:.85;">ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
            return;
          }

          const sessions = data.sessions || [];
          if (sessions.length === 0) {
            sessionListEl.innerHTML = `<div style="opacity:.85;">(í•´ë‹¹ ê¸°ê°„) ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
            return;
          }

          sessionListEl.innerHTML = "";

          sessions.forEach((s, index) => {
            const item = document.createElement("div");
            item.className = "session-item";

            const focus2 = Number(s.focus_percent ?? 0).toFixed(2);

            item.innerHTML = `
            <div class="session-info">
              <div class="session-title">ê²€ì‚¬ ${index + 1}</div>
              <div class="session-sub">ì„ íƒí•œ ì‘ì—…: <b>${s.selected_task || "-"}</b></div>
            </div>
            <div class="session-focus">${focus2}%</div>
            `;
            item.addEventListener("click", () => loadSessionDetail(s.session_id, index + 1));
            sessionListEl.appendChild(item);
          });

        } catch (err) {
          console.error(err);
          sessionListEl.innerHTML = `<div style="opacity:.85;">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>`;
        }
      }

      /* --------------------------------------
         ì„¸ì…˜ ìƒì„¸ ëª¨ë‹¬
      -------------------------------------- */
      let pieChartInstance = null;

      function destroyDetailCharts() {
        if (pieChartInstance) {
          pieChartInstance.destroy();
          pieChartInstance = null;
        }
      }

      function normalizeResult(raw) {
        const r = raw || {};
        if (!r.engagement) r.engagement = {};
        return r;
      }

async function loadSessionDetail(sessionId, testNo) {
  const modalBody = document.getElementById("modalBody");
  modalBody.innerHTML = `<div style="opacity:.85;">ìƒì„¸ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>`;
  openModal();

  try {
    let res = await fetch(`/api/mypage/session/${sessionId}`);
    let data = await res.json();

    if (!res.ok || !data.ok) {
      res = await fetch(`/api/session/${sessionId}`);
      data = await res.json();
    }
    if (!res.ok || !data.ok) {
      modalBody.innerHTML = `<div style="opacity:.85;">ìƒì„¸ ë¡œë“œ ì‹¤íŒ¨</div>`;
      return;
    }

    // âœ… r ë¨¼ì € ì„ ì–¸
    const r = normalizeResult(data.analyzeResult || data.result || data);

    /* âœ… í™œë™ ë¹„ìœ¨(ë¬¸ìì—´ì´ë©´ íŒŒì‹±) */
    let ad = r.activity_distribution || r.activity_distribution_json || {};
    if (typeof ad === "string") {
      try { ad = JSON.parse(ad); } catch (e) { ad = {}; }
    }
    const distPercent = ad.percent || {};

    /* âœ… ì§‘ì¤‘ë„ */
    const focus2 = Number(r.focus_percent ?? 0).toFixed(2);

    /* âœ… ì ìˆ˜ ë¹„ìœ¨ */
    const idleTime = Number(r.idle_time_sec ?? 0);
    const durForIdle = (() => {
      const st = r.session_start;
      const et = r.session_end;
      const sDate = st ? new Date(st.replace(" ", "T")) : null;
      const eDate = et ? new Date(et.replace(" ", "T")) : null;
      if (!sDate || !eDate || isNaN(sDate) || isNaN(eDate)) return 0;
      return (eDate - sDate) / 1000;
    })();
    const idlePercentCalc = durForIdle > 0 ? (idleTime / durForIdle) * 100 : 0;
    const idle2 = Number(
      r.engagement?.idle_percent ?? r.idle_percent ?? idlePercentCalc
    ).toFixed(2);

    /* âœ… ê²€ì‚¬ â€œì´ ì‹œê°„â€ ë§Œë“¤ê¸° (start/end ì°¨ì´) */
    // âœ… ê²€ì‚¬ ì´ ì‹œê°„(ì‹œì‘~ì¢…ë£Œ ì°¨ì´) ê³„ì‚° - ì•ˆì „ íŒŒì‹± ë²„ì „
function parseDateTime(raw) {
  if (!raw) return null;
  if (raw instanceof Date) return raw;
  if (typeof raw === "number") return new Date(raw);

  let s = String(raw).trim();

  // "YYYY-MM-DD HH:MM:SS" â†’ "YYYY-MM-DDTHH:MM:SS"
  if (s.includes(" ") && !s.includes("T")) {
    s = s.replace(" ", "T");
  }

  // í˜¹ì‹œ ".000000" ê°™ì€ ë§ˆì´í¬ë¡œì´ˆ ë¶™ìœ¼ë©´ ì œê±°
  s = s.replace(/\.\d+$/, "");

  const d = new Date(s);
  return isNaN(d) ? null : d;
}

const start = parseDateTime(r.session_start || r.start_time);
const end   = parseDateTime(r.session_end   || r.end_time);

let durationStr = "-";
if (start && end) {
  const durSec = Math.max(0, (end - start) / 1000);

  if (durSec >= 3600) {
    const h = Math.floor(durSec / 3600);
    const m = Math.floor((durSec % 3600) / 60);
    durationStr = `${h}ì‹œê°„ ${m}ë¶„`;
  } else if (durSec >= 60) {
    const m = Math.floor(durSec / 60);
    const s = Math.floor(durSec % 60);
    durationStr = `${m}ë¶„ ${s}ì´ˆ`;
  } else {
    durationStr = `${durSec.toFixed(1)}ì´ˆ`;
  }
}


    modalBody.innerHTML = `
      <div class="detail-wrap">
        <div class="detail-left">
          <div class="detail-title">ê²€ì‚¬ ${testNo} ìš”ì•½</div>
          <div class="summary-stack">
            <div class="summary-box">ì„ íƒí•œ ì‘ì—… <b>${r.selected_task || "-"}</b></div>
            <div class="summary-box">ì§‘ì¤‘ë„ <b>${focus2}%</b></div>
            <div class="summary-box">ì ìˆ˜ ë¹„ìœ¨ <b>${idle2}%</b></div>
            <div class="summary-box">ê²€ì‚¬ ì‹œê°„ <b>${durationStr}</b></div>
          </div>
        </div>

        <div class="detail-right">
          <div class="chart-title">í™œë™ ë¹„ìœ¨</div>
          <canvas id="detailPie"></canvas>
        </div>
      </div>
    `;

    renderDetailPie(distPercent);

  } catch (err) {
    console.error(err);
    modalBody.innerHTML = `<div style="opacity:.85;">ìƒì„¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>`;
  }
}



      function renderDetailPie(dist) {
  const canvas = document.getElementById("detailPie");
  if (!canvas || typeof Chart === "undefined") {
    console.log("Chart.js ë¡œë“œ ì•ˆ ë¨ or canvas ì—†ìŒ");
    return;
  }

  destroyDetailCharts(); // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°

  // âœ… distê°€ ë¹„ì—ˆìœ¼ë©´ ratioë¡œ fallback
  let distObj = dist && Object.keys(dist).length ? dist : null;

  if (!distObj) {
    const r2 = window.__lastDetailResult || {};
    distObj =
      r2.activity_distribution?.percent ||
      r2.activity_distribution?.ratio ||
      {};
  }

  const labels = Object.keys(distObj);
  const values = Object.values(distObj);

  // âœ… ë°ì´í„°ê°€ ì§„ì§œ ì—†ìœ¼ë©´ ì•ˆë‚´ë§Œ í‘œì‹œ
  if (!labels.length) {
    const ctx = canvas.getContext("2d");
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "rgba(255,255,255,0.7)";
    ctx.font = "14px sans-serif";
    ctx.fillText("í™œë™ ë¹„ìœ¨ ë°ì´í„° ì—†ìŒ", 10, 30);
    return;
  }

  const ctx = canvas.getContext("2d");

  pieChartInstance = new Chart(ctx, {
    type: "pie",
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: [
          "#7c4dff",
          "#ff6b6b",
          "#4dd0e1",
          "#ffd54f",
          "#81c784",
          "#ba68c8",
          "#90caf9"
        ]
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: "bottom" } }
      
    }
  });
}

      /* --------------------------------------
         Study ìš”ì•½
      -------------------------------------- */
      let dailyChart = null;

     async function loadStudySummary() {
  document.getElementById("study-total-sessions").textContent = "-";
  document.getElementById("study-avg-focus").textContent = "-";
  document.getElementById("study-top-distract").textContent = "-";

  try {
    // 1) ì„¸ì…˜ ëª©ë¡ ë¨¼ì € ê°€ì ¸ì˜¤ê¸° (ì—¬ê¸°ì—” distê°€ ì—†ìŒ!)
    const listRes = await fetch(`/api/mypage/sessions?userId=${user.user_id}`);
    const listData = await listRes.json();

    if (!listRes.ok || !listData.ok) {
      renderDailyFocusChart([]);
      return;
    }

    const all = listData.sessions || [];
    const studyList = all.filter(s => s.selected_task === "study");

    // 2) Study ì„ íƒ íšŸìˆ˜ / í‰ê·  ì§‘ì¤‘ë„
    document.getElementById("study-total-sessions").textContent = studyList.length;

    const focuses = studyList.map(s => Number(s.focus_percent ?? 0));
    const avgFocus = focuses.length
      ? focuses.reduce((a,b)=>a+b,0) / focuses.length
      : 0;
    document.getElementById("study-avg-focus").textContent = avgFocus.toFixed(1) + "%";

    // 3) âœ… ê° study ì„¸ì…˜ì˜ "ìƒì„¸"ë¥¼ ë‹¤ì‹œ ë¶ˆëŸ¬ì™€ì„œ dist ëª¨ìœ¼ê¸°
    const detailResults = await Promise.all(
      studyList.map(async (s) => {
        // mypage/detail ë¨¼ì € ì‹œë„, ì‹¤íŒ¨í•˜ë©´ ê¸°ì¡´ detailë¡œ fallback
        let r = null;

        try {
          let res = await fetch(`/api/mypage/session/${s.session_id}`);
          let data = await res.json();
          if (res.ok && data.ok) r = data.analyzeResult || data.result || data;
        } catch(e){}

        if (!r) {
          try {
            let res2 = await fetch(`/api/session/${s.session_id}`);
            let data2 = await res2.json();
            if (res2.ok && data2.ok) r = data2.analyzeResult || data2.result || data2;
          } catch(e){}
        }

        return r; // nullì¼ ìˆ˜ë„ ìˆìŒ
      })
    );

    // 4) ìµœëŒ€ ë°©í•´ í™œë™ ê³„ì‚°
    const distractTotals = {};
    detailResults.forEach(r => {
      if (!r) return;

      let ad = r.activity_distribution || r.activity_distribution_json || {};
      if (typeof ad === "string") {
        try { ad = JSON.parse(ad); } catch(e){ ad = {}; }
      }

      const perc = ad.percent || ad.ratio || ad || {};
      Object.entries(perc).forEach(([k,v]) => {
        if (k === "study") return;
        const num = Number(v ?? 0);
        if (!isFinite(num)) return;
        distractTotals[k] = (distractTotals[k] || 0) + num;
      });
    });

    let topDistractKey = "-";
    const sorted = Object.entries(distractTotals).sort((a,b)=>b[1]-a[1]);
    if (sorted.length) topDistractKey = sorted[0][0];

    const labelMap = {
      "webtoon": "ì›¹íˆ°",
      "sns": "SNS",
      "game": "ê²Œì„",
      "youtube-ent": "ìœ íŠœë¸Œ(ì˜¤ë½)",
      "youtube_mus": "ìœ íŠœë¸Œ(ìŒì•…)",
      "youtube-music": "ìœ íŠœë¸Œ(ìŒì•…)",
      "youtube_entertain": "ìœ íŠœë¸Œ(ì˜¤ë½)",
      "youtube_music": "ìœ íŠœë¸Œ(ìŒì•…)",
      "other": "ê¸°íƒ€"
    };

    document.getElementById("study-top-distract").textContent =
      labelMap[topDistractKey] || topDistractKey || "-";

    // 5) ì¼ë³„ ì§‘ì¤‘ë„ ê·¸ë˜í”„ëŠ” â€˜ëª©ë¡â€™ìœ¼ë¡œ ê·¸ë ¤ë„ OK
    renderDailyFocusChart(studyList);

  } catch (err) {
    console.error(err);
    renderDailyFocusChart([]);
  }
}


      function renderDailyFocusChart(sessions) {
        const ctx = document.getElementById("weekly-focus-chart").getContext("2d");

        const today = new Date();
        today.setHours(0,0,0,0);

        const days = [];
        for (let i = 6; i >= 0; i--) {
          const d = new Date(today);
          d.setDate(today.getDate() - i);
          days.push(d);
        }

        const labels = days.map(d => `${d.getMonth()+1}/${d.getDate()}`);

        const bucket = {};
        sessions.forEach(s => {
          const dateStr = s.date || s.created_at;
          if (!dateStr) return;

          const d = new Date(dateStr);
          d.setHours(0,0,0,0);
          const key = d.toISOString().slice(0,10);

          bucket[key] = bucket[key] || [];
          bucket[key].push(Number(s.focus_percent ?? 0));
        });

        const values = days.map(d => {
          const key = d.toISOString().slice(0,10);
          const arr = bucket[key] || [];
          if (!arr.length) return null;
          return arr.reduce((a,b)=>a+b,0) / arr.length;
        });

        if (dailyChart) dailyChart.destroy();

        dailyChart = new Chart(ctx, {
  type: "line",
  data: {
    labels,
    datasets: [{
      label: "ì¼ë³„ ì§‘ì¤‘ë„(%)",
      data: values,
      tension: 0.35,
      spanGaps: false,   // âœ… ì—¬ê¸° ì½¤ë§ˆ ê¼­ ìˆì–´ì•¼ í•¨!

      borderColor: "#ffffff",
      pointBackgroundColor: "#ffffff",
      backgroundColor: "rgba(255,255,255,0.08)",
      borderWidth: 2
    }]
  },
  options: {
    responsive: true,
    plugins: { legend: { display: false } },
    scales: { y: { beginAtZero: true, max: 100 } }
  }
});
      }

    });
  </script>

</body>
</html>
